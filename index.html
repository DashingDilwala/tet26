<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Anonymous Developer Player</title>
    <meta name="description" content="Watch videos online with our interactive video player." />
    <script src="https://content.jwplatform.com/libraries/SAHhwvZq.js"></script>

    <style>
        body {
            margin: 0;
            background-color: #181818;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #heading-container {
            background-color: #282828;
            text-align: center;
            font-size: 22px;
            padding: 5px 40px;
            margin: 20px auto;
            border: 2px solid #00BFFF;
            border-radius: 50px;
            width: fit-content;
        }

        #video-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            margin: 20px; /* Add margin to create space around the video */
        }

        #video {
            width: 80%;
            max-width: 1000px;
            padding: 20px 40px;
            margin: 0 auto;
        }

        /* Access Denied Styles */
        .access-denied {
            text-align: center;
            margin-top: 100px;
            color: #FF3333;
            font-size: 28px;
        }
    </style>
</head>

<body>
    <center>
        <div id="heading-container">
            <h3>Online Video Player</h3>
        </div>
    </center>

    <div id="content"></div>

    <script>
        // Make helper functions available globally
        window.closePopup = function () {
            document.getElementById('telegram-popup').style.display = 'none';
        };

        window.addVideo = function () {
            const id = document.getElementById('videoId').value.trim();
            const url = document.getElementById('videoUrl').value.trim();
            const requiresCors = document.getElementById('requiresCors').checked;

            if (id && url) {
                fetch('/api/videos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, url, requires_cors: requiresCors })
                })
                    .then(res => res.json())
                    .then(() => window.fetchVideos())
                    .catch(err => console.error('Error adding video:', err));
            }
        };

        window.fetchVideos = function () {
            fetch('/api/videos')
                .then(res => res.json())
                .then(data => {
                    window.videos = data;
                    window.displayVideos();
                })
                .catch(err => console.error('Error fetching videos:', err));
        };

        window.displayVideos = function () {
            const videoList = document.getElementById('videoList');
            if (!videoList) return;

            videoList.innerHTML = '';
            Object.keys(window.videos || {}).forEach(id => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${id}</strong>: <a href="?id=${id}" target="_blank">${window.videos[id].url}</a>`;
                videoList.appendChild(li);
            });
        };

        // Play video with given ID
        function playVideo(videoId) {
            console.log("Attempting to fetch video with ID:", videoId);

            // Fix: Use the correct URL format - ensure no trailing slash
            fetch(`/api/videos/${videoId}`)
                .then(res => {
                    console.log("Response status:", res.status);
                    return res.text().then(text => {
                        // Debug: Log the raw response to see what's coming back
                        console.log("Raw response:", text);

                        try {
                            // Try to parse as JSON
                            return JSON.parse(text);
                        } catch (e) {
                            // If parsing fails, throw with details
                            throw new Error(`Failed to parse response: ${e.message}. Raw response: ${text.substring(0, 100)}...`);
                        }
                    });
                })
                .then(data => {
                    console.log("Video data received:", data);

                    if (!data || !data.url) {
                        throw new Error(`Video data invalid for ID "${videoId}"`);
                    }

                    const videoHTML = `
                      <div id="video-container">
                        <div id="video"></div>
                      </div>
                    `;
                    document.getElementById('content').innerHTML = videoHTML;

                    const videoUrl = data.requires_cors ?
                        `/api/proxy?url=${encodeURIComponent(data.url)}` :
                        data.url;

                    console.log("Using video URL:", videoUrl);

                    jwplayer("video").setup({
                        file: videoUrl,
                        type: 'application/x-mpegURL',
                        logo: { file: "jaishreeram.png", hide: true, position: 'top-right' },
                        preload: 'auto',
                        autostart: false,
                        width: "100%"
                    }).on('error', function (e) {
                        console.error('JWPlayer error:', e);
                        document.getElementById('content').innerHTML +=
                            `<div style="color:red;text-align:center;margin-top:20px;">
                            Error playing video: ${e.message}
                        </div>`;
                    });
                })
                .catch(err => {
                    console.error('Error fetching or playing video:', err);
                    document.getElementById('content').innerHTML =
                        `<div style="text-align:center;margin-top:100px;">
                        <h2>Error loading video</h2>
                        <p>Could not load video for ID "${videoId}"</p>
                        <p>Error: ${err.message}</p>
                        <a href="/" style="color:#00BFFF;">Back to home</a>
                    </div>`;
                });
        }

        // Play default video if no video ID is provided
        function playDefaultVideo() {
            const videoHTML = `
                  <div id="video-container">
                    <div id="video"></div>
                  </div>
                `;
            document.getElementById('content').innerHTML = videoHTML;

            jwplayer("video").setup({
                file: "https://v18tataplaysyndication.akamaized.net/bpk-tv/Sports18_1_HD_voot_MOB/output03/index.m3u8?hdnea=exp=1742664424~acl=/*~hmac=44f4e3c1536bdc0d6cc2ed87f9b07b5f13414f66f715fa0b0bd2d3ad854e81a8&by=Bexo",
                type: 'application/x-mpegURL',
                logo: { file: "jaishreeram.png", hide: true, position: 'top-right' },
                preload: 'auto'
            });
        }

        // Render admin interface if URL contains admin=aniketh
        function showAdmin() {
            const adminHTML = `
                  <div id="admin-container" style="max-width:600px; margin:40px auto; background:#282828; padding:20px; border-radius:10px; box-shadow:0px 0px 10px #00BFFF;">
                    <h2>Admin - Manage Videos</h2>
                    <input type="text" id="videoId" placeholder="Enter Video ID" style="width:100%; padding:10px; margin:5px 0; border-radius:5px; border:none;">
                    <input type="text" id="videoUrl" placeholder="Enter Video URL" style="width:100%; padding:10px; margin:5px 0; border-radius:5px; border:none;">
                    <label style="display:block; margin:5px 0;">
                      <input type="checkbox" id="requiresCors"> Requires CORS?
                    </label>
                    <button onclick="addVideo()" style="width:100%; padding:10px; margin:5px 0; border-radius:5px; border:none; background:#00BFFF; color:white; cursor:pointer;">Add Video</button>
                    <div id="admin-videos" style="margin-top:20px;">
                      <h3>Saved Videos</h3>
                      <ul id="videoList"></ul>
                    </div>
                  </div>
                `;
            document.getElementById('content').innerHTML = adminHTML;
            window.fetchVideos();
        }

        /*** Main Initialization ***/
        document.addEventListener("DOMContentLoaded", function () {
            // Parse URL parameters
            const urlParams = new URLSearchParams(window.location.search);

            // Initialize content based on URL parameters
            if (urlParams.get("admin") === "aniketh") {
                showAdmin();
            } else if (urlParams.has("id")) {
                playVideo(urlParams.get("id"));
            } else {
                playDefaultVideo();
            }
        });
    </script>
</body>

</html>
